---
import BaseLayout from './BaseLayout.astro';
const { frontmatter } = Astro.props;

// 1. Safety Check: Default values if metadata is missing
const post = frontmatter || {};
const title = post.title || 'No Title';
const author = post.author || 'Anonymous';
const date = post.date || '2026-01-01';

// 2. Generate Post ID (Replace spaces with hyphens)
const postId = title.replace(/\s+/g, '-').toLowerCase();
---

<BaseLayout title={title}>
  <article class="blog-post">
    <header class="post-header">
      <div class="meta-top">
        <span class="category">{post.category || 'Daily Log'}</span>
        <span class="location">üìç {post.location || 'Earth'}</span>
      </div>
      
      <h1>{title}</h1>
      
      <div class="author-info">
        <span class="author-name">Written by <b>{author}</b></span>
        <span class="post-date">on {date}</span>
      </div>
      
      {post.image && (
        <img src={post.image} alt={title} class="featured-image" />
      )}
      <hr />
    </header>

    <div class="content">
      <slot />
    </div>

    <div class="reaction-zone">
      <h4>How was this signal? (Anonymous)</h4>
      <p class="reaction-desc">No login required. Just click to share your vibe.</p>
      
      <div class="buttons-wrapper" id="reaction-buttons" data-post-id={postId}>
        
        <button class="react-btn" data-type="likes">
          üëç Like <span class="count" id="count-likes">0</span>
        </button>
        
        <button class="react-btn" data-type="heart">
          ‚ù§Ô∏è Love <span class="count" id="count-heart">0</span>
        </button>

        <button class="react-btn" data-type="cheer">
          üî• Fire <span class="count" id="count-cheer">0</span>
        </button>
        
        <button class="react-btn" data-type="sad">
          üò¢ Sad <span class="count" id="count-sad">0</span>
        </button>

      </div>
    </div>

  </article>
</BaseLayout>

<script>
  import { initializeApp } from "firebase/app";
  import { getFirestore, doc, setDoc, updateDoc, onSnapshot, increment, getDoc } from "firebase/firestore";

  // 1. Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAs0haGNTLr4pFsMt8ogdPoY6KDEFuRwL0",
    authDomain: "the-besedka-loop.firebaseapp.com",
    projectId: "the-besedka-loop",
    storageBucket: "the-besedka-loop.firebasestorage.app",
    messagingSenderId: "464046867014",
    appId: "1:464046867014:web:e37d3039b144f5d3710047",
    measurementId: "G-HL8JJ5WYVK"
  };

  // 2. Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 3. Get Current Post ID
  const wrapper = document.getElementById('reaction-buttons');
  const postId = wrapper.dataset.postId;
  const postRef = doc(db, "posts", postId);

  // 4. [Read] Realtime Listener
  onSnapshot(postRef, (docSnap) => {
    if (docSnap.exists()) {
      const data = docSnap.data();
      if (data.likes) document.getElementById('count-likes').innerText = data.likes;
      if (data.heart) document.getElementById('count-heart').innerText = data.heart;
      if (data.cheer) document.getElementById('count-cheer').innerText = data.cheer;
      if (data.sad) document.getElementById('count-sad').innerText = data.sad;
    }
  });

  // 5. [Write] Handle Click
  const buttons = document.querySelectorAll('.react-btn');
  buttons.forEach(btn => {
    btn.addEventListener('click', async () => {
      const type = btn.dataset.type;

      // Click Animation
      btn.style.transform = "scale(1.2)";
      setTimeout(() => btn.style.transform = "scale(1)", 200);

      try {
        const docSnap = await getDoc(postRef);
        
        if (!docSnap.exists()) {
          // Create new doc if not exists
          await setDoc(postRef, { [type]: 1 });
        } else {
          // Increment count
          await updateDoc(postRef, {
            [type]: increment(1)
          });
        }
      } catch (error) {
        console.error("Error updating count:", error);
        alert("Temporary error. Please try again.");
      }
    });
  });
</script>

<style>
  /* --- Blog Post Styles --- */
  .blog-post { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

  /* Header */
  .post-header { text-align: center; margin-bottom: 2rem; }
  .meta-top { font-size: 0.85rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
  .location { margin-left: 10px; color: #3498db; }
  h1 { font-size: 2.2rem; margin: 0.5rem 0; color: #2c3e50; line-height: 1.2; }
  .author-info { font-size: 0.95rem; color: #555; margin-bottom: 1.5rem; }
  .featured-image { width: 100%; height: auto; border-radius: 8px; margin-top: 1rem; object-fit: cover; max-height: 400px; }
  hr { border: 0; border-top: 1px solid #eee; margin: 2rem 0; }

  /* Content */
  .content { line-height: 1.8; color: #333; font-size: 1.05rem; }
  .content h2, .content h3 { color: #2c3e50; margin-top: 2rem; }
  .content p { margin-bottom: 1.5rem; }
  .content blockquote { border-left: 4px solid #3498db; margin: 0; padding-left: 1rem; color: #555; font-style: italic; background: #f9f9f9; padding: 1rem; }

  /* --- Reaction Zone Styles --- */
  .reaction-zone { margin-top: 4rem; padding: 2rem; background: #f8f9fa; border-radius: 12px; text-align: center; border: 1px dashed #cbd5e0; }
  .reaction-zone h4 { margin: 0 0 0.5rem 0; color: #555; }
  .reaction-desc { font-size: 0.9rem; color: #999; margin-bottom: 1.5rem; }
  
  .buttons-wrapper { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
  
  .react-btn {
    background: white; border: 1px solid #ddd; padding: 10px 18px; 
    border-radius: 30px; cursor: pointer; font-size: 1rem; 
    transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: #444;
    font-family: inherit;
  }
  .react-btn:hover { background: #eef2f3; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .react-btn:active { transform: scale(0.95); }
  .react-btn span.count { font-weight: bold; color: #3498db; background: #eaf6ff; padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; }

  /* --- Fake Comments Styles (Markdown) --- */
  :global(.comment-box) { margin-top: 3rem; background: #fff; padding: 0; border-top: 2px solid #f1f1f1; }
  :global(.comment-box h3) { margin-bottom: 1.5rem; font-size: 1.2rem; color: #333; }
  :global(.comment) { display: flex; gap: 15px; margin-bottom: 1.5rem; align-items: flex-start; }
  :global(.comment .avatar) { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ecf0f1; background: white; object-fit: cover; }
  :global(.comment .bubble) { background: #f1f3f5; padding: 12px 18px; border-radius: 0 15px 15px 15px; position: relative; max-width: 80%; }
  :global(.comment .bubble strong) { display: block; font-size: 0.9rem; color: #2c3e50; margin-bottom: 4px; }
  :global(.comment .bubble p) { margin: 0; font-size: 0.95rem; color: #495057; line-height: 1.5; }

  /* Mobile */
  @media (max-width: 600px) {
    .blog-post { padding: 1.5rem; }
    h1 { font-size: 1.8rem; }
    .react-btn { font-size: 0.9rem; padding: 8px 12px; }
    :global(.comment .bubble) { max-width: 100%; }
  }
</style>
