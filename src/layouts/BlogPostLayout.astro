---
import BaseLayout from './BaseLayout.astro';
const { frontmatter } = Astro.props;

// ê²Œì‹œë¬¼ ì œëª©ì„ IDë¡œ ì‚¬ìš© (ê³µë°±ì„ -ë¡œ ì¹˜í™˜)
const postId = frontmatter.title.replace(/\s+/g, '-').toLowerCase();
---

<BaseLayout title={frontmatter.title}>

  <article class="blog-post">
    <header class="post-header">
       <h1>{frontmatter.title}</h1>
       <div class="author-info">Written by <b>{frontmatter.author}</b></div>
       <hr />
    </header>

    <div class="content">
      <slot />
    </div>

    <div class="reaction-zone">
      <h4>ì´ ê¸€ì— ë°˜ì‘ ë‚¨ê¸°ê¸° (ìµëª…)</h4>
      
      <div class="buttons-wrapper" id="reaction-buttons">
        <button onclick={`updateReaction('${postId}', 'likes')`} class="react-btn">
          ğŸ‘ ì¢‹ì•„ìš” <span id="count-likes">0</span>
        </button>
        
        <button onclick={`updateReaction('${postId}', 'heart')`} class="react-btn">
          â¤ï¸ ì‚¬ë‘í•´ìš” <span id="count-heart">0</span>
        </button>

        <button onclick={`updateReaction('${postId}', 'cheer')`} class="react-btn">
          ğŸ”¥ ì‘ì›í•´ <span id="count-cheer">0</span>
        </button>
        
        <button onclick={`updateReaction('${postId}', 'sad')`} class="react-btn">
          ğŸ˜¢ ìŠ¬í¼ìš” <span id="count-sad">0</span>
        </button>
      </div>
      <p class="reaction-help">â–² í´ë¦­í•˜ë©´ ê°œë°œìë“¤ì—ê²Œ í° í˜ì´ ë©ë‹ˆë‹¤.</p>
    </div>

  </article>
</BaseLayout>

<script>
  import { db } from "../lib/firebase";
  import { doc, updateDoc, setDoc, getDoc, onSnapshot, increment } from "firebase/firestore";

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë§Œë“¤ê¸° ìœ„í•´ window ê°ì²´ì— í• ë‹¹
  window.updateReaction = async (postId, type) => {
    const postRef = doc(db, "posts", postId);

    try {
      // 1. ë¬¸ì„œê°€ ìˆëŠ”ì§€ í™•ì¸
      const docSnap = await getDoc(postRef);

      if (!docSnap.exists()) {
        // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“¦ (ì²« íˆ¬í‘œ!)
        await setDoc(postRef, { [type]: 1 });
      } else {
        // ë¬¸ì„œê°€ ìˆìœ¼ë©´ ìˆ«ìë§Œ +1 (Atomic Increment)
        await updateDoc(postRef, {
          [type]: increment(1)
        });
      }
      
      // í´ë¦­ íš¨ê³¼ (ê°„ë‹¨í•œ ì• ë‹ˆë©”ì´ì…˜)
      const btn = document.querySelector(`button[onclick*="${type}"]`);
      btn.style.transform = "scale(1.2)";
      setTimeout(() => btn.style.transform = "scale(1)", 200);

    } catch (e) {
      console.error("Error updating reaction: ", e);
      alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  };

  // ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ«ì ì—…ë°ì´íŠ¸ (ë‚¨ë“¤ì´ ëˆ„ë¥´ëŠ” ê²ƒë„ ë°”ë¡œ ë³´ì„!)
  const postId = document.querySelector('.react-btn').getAttribute('onclick').split("'")[1];
  const postRef = doc(db, "posts", postId);

  onSnapshot(postRef, (doc) => {
    if (doc.exists()) {
      const data = doc.data();
      // ê° ë²„íŠ¼ì˜ ìˆ«ì(span)ë¥¼ DB ê°’ìœ¼ë¡œ ë³€ê²½
      if(data.likes) document.getElementById('count-likes').innerText = data.likes;
      if(data.heart) document.getElementById('count-heart').innerText = data.heart;
      if(data.cheer) document.getElementById('count-cheer').innerText = data.cheer;
      if(data.sad) document.getElementById('count-sad').innerText = data.sad;
    }
  });
</script>

<style>
  /* ìŠ¤íƒ€ì¼: ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ + ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
  .reaction-zone { margin-top: 4rem; padding: 2rem; background: #f8f9fa; border-radius: 12px; text-align: center; border: 1px dashed #cbd5e0; }
  .buttons-wrapper { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
  
  .react-btn {
    background: white; border: 1px solid #ddd; padding: 10px 15px; 
    border-radius: 20px; cursor: pointer; font-size: 1rem; 
    transition: all 0.2s; display: flex; align-items: center; gap: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .react-btn:hover { background: #eef2f3; transform: translateY(-2px); }
  .react-btn span { font-weight: bold; color: #3498db; }
</style>
