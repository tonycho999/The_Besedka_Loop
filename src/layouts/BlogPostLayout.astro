---
import BaseLayout from './BaseLayout.astro';
const { frontmatter } = Astro.props;

// 1. ì•ˆì „ì¥ì¹˜: ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
const post = frontmatter || {};
const title = post.title || 'No Title';
const author = post.author || 'Anonymous';
const date = post.date || '2026-01-01';

// 2. ê²Œì‹œë¬¼ ID ìƒì„± (ì œëª©ì˜ ê³µë°±ì„ í•˜ì´í”ˆìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ê³ ìœ  IDë¡œ ì‚¬ìš©)
// ì˜ˆ: "System Check" -> "system-check"
const postId = title.replace(/\s+/g, '-').toLowerCase();
---

<BaseLayout title={title}>
  <article class="blog-post">
    <header class="post-header">
      <div class="meta-top">
        <span class="category">{post.category || 'Daily Log'}</span>
        <span class="location">ğŸ“ {post.location || 'Earth'}</span>
      </div>
      
      <h1>{title}</h1>
      
      <div class="author-info">
        <span class="author-name">Written by <b>{author}</b></span>
        <span class="post-date">on {date}</span>
      </div>
      
      {post.image && (
        <img src={post.image} alt={title} class="featured-image" />
      )}
      <hr />
    </header>

    <div class="content">
      <slot />
    </div>

    <div class="reaction-zone">
      <h4>ì´ ê¸€ì— ë°˜ì‘ ë‚¨ê¸°ê¸° (ìµëª…)</h4>
      <p class="reaction-desc">ë¡œê·¸ì¸ ì—†ì´ í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ë§ˆìŒì„ ì „í•˜ì„¸ìš”.</p>
      
      <div class="buttons-wrapper" id="reaction-buttons" data-post-id={postId}>
        
        <button class="react-btn" data-type="likes">
          ğŸ‘ ì¢‹ì•„ìš” <span class="count" id="count-likes">0</span>
        </button>
        
        <button class="react-btn" data-type="heart">
          â¤ï¸ ì‚¬ë‘í•´ìš” <span class="count" id="count-heart">0</span>
        </button>

        <button class="react-btn" data-type="cheer">
          ğŸ”¥ ì‘ì›í•´ <span class="count" id="count-cheer">0</span>
        </button>
        
        <button class="react-btn" data-type="sad">
          ğŸ˜¢ ìŠ¬í¼ìš” <span class="count" id="count-sad">0</span>
        </button>

      </div>
    </div>

  </article>
</BaseLayout>

<script>
  import { initializeApp } from "firebase/app";
  import { getFirestore, doc, setDoc, updateDoc, onSnapshot, increment, getDoc } from "firebase/firestore";

  // 1. ì‚¬ìš©ìë¶„ì´ ì œê³µí•´ì£¼ì‹  Firebase ì„¤ì •
  const firebaseConfig = {
    apiKey: "AIzaSyAs0haGNTLr4pFsMt8ogdPoY6KDEFuRwL0",
    authDomain: "the-besedka-loop.firebaseapp.com",
    projectId: "the-besedka-loop",
    storageBucket: "the-besedka-loop.firebasestorage.app",
    messagingSenderId: "464046867014",
    appId: "1:464046867014:web:e37d3039b144f5d3710047",
    measurementId: "G-HL8JJ5WYVK"
  };

  // 2. Firebase ì´ˆê¸°í™”
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 3. í˜„ì¬ ê²Œì‹œë¬¼ ID ê°€ì ¸ì˜¤ê¸° (HTMLì—ì„œ ì½ì–´ì˜´)
  const wrapper = document.getElementById('reaction-buttons');
  const postId = wrapper.dataset.postId;
  const postRef = doc(db, "posts", postId);

  // 4. [ì½ê¸°] ì‹¤ì‹œê°„ ë°ì´í„° ê°ì§€ (onSnapshot)
  // ë‚¨ì´ ëˆ„ë¥´ë©´ ë‚´ í™”ë©´ ìˆ«ìë„ ë°”ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.
  onSnapshot(postRef, (docSnap) => {
    if (docSnap.exists()) {
      const data = docSnap.data();
      // ê° ë²„íŠ¼ì˜ ìˆ«ìë¥¼ DB ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
      if (data.likes) document.getElementById('count-likes').innerText = data.likes;
      if (data.heart) document.getElementById('count-heart').innerText = data.heart;
      if (data.cheer) document.getElementById('count-cheer').innerText = data.cheer;
      if (data.sad) document.getElementById('count-sad').innerText = data.sad;
    }
  });

  // 5. [ì“°ê¸°] ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
  const buttons = document.querySelectorAll('.react-btn');
  buttons.forEach(btn => {
    btn.addEventListener('click', async () => {
      const type = btn.dataset.type; // likes, heart, cheer, sad ì¤‘ í•˜ë‚˜

      // í´ë¦­ íš¨ê³¼ (ì• ë‹ˆë©”ì´ì…˜)
      btn.style.transform = "scale(1.2)";
      setTimeout(() => btn.style.transform = "scale(1)", 200);

      try {
        const docSnap = await getDoc(postRef);
        
        if (!docSnap.exists()) {
          // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„± (ì²« íˆ¬í‘œ)
          await setDoc(postRef, { [type]: 1 });
        } else {
          // ë¬¸ì„œê°€ ìˆìœ¼ë©´ ìˆ«ìë§Œ +1 ì¦ê°€ (Atomic Increment)
          await updateDoc(postRef, {
            [type]: increment(1)
          });
        }
      } catch (error) {
        console.error("Error updating count:", error);
        alert("ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  });
</script>

<style>
  /* --- ë¸”ë¡œê·¸ ê²Œì‹œê¸€ ìŠ¤íƒ€ì¼ --- */
  .blog-post { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

  /* í—¤ë” ìŠ¤íƒ€ì¼ */
  .post-header { text-align: center; margin-bottom: 2rem; }
  .meta-top { font-size: 0.85rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
  .location { margin-left: 10px; color: #3498db; }
  h1 { font-size: 2.2rem; margin: 0.5rem 0; color: #2c3e50; line-height: 1.2; }
  .author-info { font-size: 0.95rem; color: #555; margin-bottom: 1.5rem; }
  .featured-image { width: 100%; height: auto; border-radius: 8px; margin-top: 1rem; object-fit: cover; max-height: 400px; }
  hr { border: 0; border-top: 1px solid #eee; margin: 2rem 0; }

  /* ë³¸ë¬¸ ë‚´ìš© ìŠ¤íƒ€ì¼ */
  .content { line-height: 1.8; color: #333; font-size: 1.05rem; }
  .content h2, .content h3 { color: #2c3e50; margin-top: 2rem; }
  .content p { margin-bottom: 1.5rem; }
  .content blockquote { border-left: 4px solid #3498db; margin: 0; padding-left: 1rem; color: #555; font-style: italic; background: #f9f9f9; padding: 1rem; }

  /* --- ë¦¬ì•¡ì…˜ ì¡´ (Firebase ë²„íŠ¼) ìŠ¤íƒ€ì¼ --- */
  .reaction-zone { margin-top: 4rem; padding: 2rem; background: #f8f9fa; border-radius: 12px; text-align: center; border: 1px dashed #cbd5e0; }
  .reaction-zone h4 { margin: 0 0 0.5rem 0; color: #555; }
  .reaction-desc { font-size: 0.9rem; color: #999; margin-bottom: 1.5rem; }
  
  .buttons-wrapper { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
  
  .react-btn {
    background: white; border: 1px solid #ddd; padding: 10px 18px; 
    border-radius: 30px; cursor: pointer; font-size: 1rem; 
    transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: #444;
    font-family: inherit;
  }
  .react-btn:hover { background: #eef2f3; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .react-btn:active { transform: scale(0.95); }
  .react-btn span.count { font-weight: bold; color: #3498db; background: #eaf6ff; padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; }

  /* --- [ì¤‘ìš”] ë©¤ë²„ë“¤ì˜ ê°€ì§œ ëŒ“ê¸€ ìŠ¤íƒ€ì¼ (Markdownìš©) --- */
  /* ì´ ìŠ¤íƒ€ì¼ì´ ìˆì–´ì•¼ Markdownì— ì ì–´ë‘” HTML ëŒ“ê¸€ì´ ì˜ˆì˜ê²Œ ë³´ì…ë‹ˆë‹¤ */
  :global(.comment-box) { margin-top: 3rem; background: #fff; padding: 0; border-top: 2px solid #f1f1f1; }
  :global(.comment-box h3) { margin-bottom: 1.5rem; font-size: 1.2rem; color: #333; }
  :global(.comment) { display: flex; gap: 15px; margin-bottom: 1.5rem; align-items: flex-start; }
  :global(.comment .avatar) { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ecf0f1; background: white; object-fit: cover; }
  :global(.comment .bubble) { background: #f1f3f5; padding: 12px 18px; border-radius: 0 15px 15px 15px; position: relative; max-width: 80%; }
  :global(.comment .bubble strong) { display: block; font-size: 0.9rem; color: #2c3e50; margin-bottom: 4px; }
  :global(.comment .bubble p) { margin: 0; font-size: 0.95rem; color: #495057; line-height: 1.5; }

  /* ëª¨ë°”ì¼ ëŒ€ì‘ */
  @media (max-width: 600px) {
    .blog-post { padding: 1.5rem; }
    h1 { font-size: 1.8rem; }
    .react-btn { font-size: 0.9rem; padding: 8px 12px; }
    :global(.comment .bubble) { max-width: 100%; }
  }
</style>
